node {
    stage 'Checkout'
    checkout scm

    stage 'Prepare'
    lock('dependencies') {
        sh 'ci/install-dependencies.sh'
    }

    stage 'Build'
    sh './gradlew release -Prelease.useAutomaticVersion=true'

    stage 'Archive Artifacts'
    step([$class: 'ArtifactArchiver', artifacts: '**/build/**/*.apk', fingerprint: true])

    stage 'Release Inapp'
    androidApkUpload googleCredentialsId: 'andfhemplayupload', apkFilesPattern: 'build/outputs/apk/workspace-inapp-release.apk', trackName: 'production'

    stage 'Release Premium'
    androidApkUpload googleCredentialsId: 'andfhemplayupload', apkFilesPattern: 'build/outputs/apk/workspace-premium-release.apk', trackName: 'production'

    stage 'Upload GitHub'
    sh './gradlew githubRelease'

    stage 'Generate JavaDoc'
    sh './gradlew javadocinappDebug'
}